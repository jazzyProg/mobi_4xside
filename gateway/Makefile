# gateway/Makefile

.PHONY: help up down restart logs build status clean

help:
	@echo "Production System Management"
	@echo "============================"
	@echo "make up          - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É"
	@echo "make down        - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É"
	@echo "make restart     - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É"
	@echo "make logs        - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
	@echo "make build       - –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å–µ –æ–±—Ä–∞–∑—ã"
	@echo "make status      - –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤"
	@echo "make clean       - –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ (volumes + images)"
	@echo ""
	@echo "–û—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
	@echo "make logs-qc     - –õ–æ–≥–∏ QC Service"
	@echo "make logs-camera - –õ–æ–≥–∏ Camera API"
	@echo "make logs-signals- –õ–æ–≥–∏ Signals API"
	@echo "make logs-db     - –õ–æ–≥–∏ Products API"
	@echo ""
	@echo "make restart-qc  - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å QC Service"
	@echo "make update-qc   - –û–±–Ω–æ–≤–∏—Ç—å QC Service –±–µ–∑ –¥–∞—É–Ω—Ç–∞–π–º–∞"

# –ó–∞–ø—É—Å–∫ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
up:
	@echo "üöÄ Starting production system..."
	docker-compose up -d
	@sleep 5
	@echo "‚úÖ System started!"
	@make status

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
down:
	@echo "üõë Stopping production system..."
	docker-compose down
	@echo "‚úÖ System stopped!"

# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
restart:
	@echo "üîÑ Restarting production system..."
	docker-compose restart
	@echo "‚úÖ System restarted!"

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤
build:
	@echo "üî® Building all services..."
	docker-compose build --no-cache --parallel
	@echo "‚úÖ Build complete!"

# –õ–æ–≥–∏
logs:
	docker-compose logs -f --tail=100

logs-qc:
	docker-compose logs -f --tail=100 qc-service

logs-camera:
	docker-compose logs -f --tail=100 camera-api

logs-signals:
	docker-compose logs -f --tail=100 signals-api

logs-db:
	docker-compose logs -f --tail=100 db-api

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
restart-qc:
	docker-compose restart qc-service

restart-camera:
	docker-compose restart camera-api

restart-signals:
	docker-compose restart signals-api

restart-db:
	docker-compose restart db-api

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –±–µ–∑ –¥–∞—É–Ω—Ç–∞–π–º–∞
update-qc:
	@echo "üì¶ Updating QC Service..."
	cd ../prod_4x && git pull
	docker-compose build qc-service
	docker-compose up -d --no-deps qc-service
	@echo "‚úÖ QC Service updated!"

update-camera:
	@echo "üì¶ Updating Camera API..."
	cd ../camera_4x && git pull
	docker-compose build camera-api
	docker-compose up -d --no-deps camera-api
	@echo "‚úÖ Camera API updated!"

# –°—Ç–∞—Ç—É—Å
status:
	@echo "üìä System Status:"
	@echo "================"
	@docker-compose ps
	@echo ""
	@echo "üè• Health Checks:"
	@echo "================"
	@curl -s http://localhost:8080/health | jq . || echo "Gateway: ‚ùå"
	@curl -s http://localhost:8080/api/qc/health | jq . || echo "QC Service: ‚ùå"
	@curl -s http://localhost:8080/api/camera/health | jq . || echo "Camera API: ‚ùå"
	@curl -s http://localhost:8080/api/signals/health | jq . || echo "Signals API: ‚ùå"
	@curl -s http://localhost:8080/api/products/health | jq . || echo "Products API: ‚ùå"

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "üßπ Cleaning up..."
	docker-compose down -v
	docker system prune -f
	@echo "‚úÖ Cleanup complete!"

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å –æ–±—Ä–∞–∑–∞–º–∏
clean-all:
	@echo "üßπ Deep cleaning..."
	docker-compose down -v --rmi all
	docker system prune -af
	@echo "‚úÖ Deep cleanup complete!"
